name: Build & Deploy to Staging

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy-check:
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
    steps:
      - name: Check for Credentials
        id: check
        run: |
          if [ -z "${{ secrets.GCP_CREDENTIALS }}" ]; then
            echo "No GCP credentials found. Skipping deployment."
            echo "deploy=false" >> $GITHUB_OUTPUT
          else
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

  build-deploy:
    needs: deploy-check
    if: needs.deploy-check.outputs.deploy == 'true'
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: staging
      DOMAIN: ${{ secrets.STAGING_DOMAIN }}
      PROJECT_NAME: ${{ secrets.PROJECT_NAME }}
      FRONTEND_HOST: ${{ secrets.STAGING_FRONTEND_HOST }}
      CLUSTER: ${{ secrets.STAGING_CLUSTER }}
      REGION: ${{ secrets.STAGING_REGION }}
      STACK_NAME: ${{ secrets.STAGING_STACK_NAME }}
      BUILD_TAG: ${{ github.sha }}
    steps:
      # 1) Checkout & detect changed targets
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide build & deploy targets
        id: detect
        run: |
          mapfile -t files < <(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
          services=(); build_frontend=false

          for f in "${files[@]}"; do
            case "$f" in
              # any change in frontend code or its k8s manifests
              frontend/*|k8s/deployments/frontend/*)
                build_frontend=true
                ;;
              # any change in libs (rebuild all services)
              libs/*)
                for dir in services/*/; do
                  [[ -f "$dir/Dockerfile" ]] && services+=("$(basename "$dir")")
                done
                break
                ;;
              # any change in one of the services
              services/*)
                svc=${f#services/}
                svc=${svc%%/*}
                services+=( "$svc" )
                ;;
              # any change in one of the services' k8s manifests
              k8s/deployments/services/*)
                svc=${f#k8s/deployments/services/}
                svc=${svc%%/*}
                services+=( "$svc" )
                ;;
            esac
          done

          # dedupe
          services=( $(printf "%s\n" "${services[@]}" | sort -u) )

          echo "→ Services to build: ${services[*]:-(none)}"
          echo "→ Build frontend: $build_frontend"

          echo "services=$(IFS=,; echo "${services[*]}")" >> $GITHUB_OUTPUT
          echo "build_frontend=$build_frontend"       >> $GITHUB_OUTPUT

      # 2) Install tools & authenticate
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Sign in to Google Cloud
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.13.0

      # 3) Build & push changed services
      - name: Build & push services
        if: steps.detect.outputs.services != ''
        run: |
          IFS=, read -ra SVCS <<< "${{ steps.detect.outputs.services }}"
          for svc in "${SVCS[@]}"; do
            image=${{ secrets.DOCKER_USERNAME }}/${STACK_NAME}-${svc,,}:${BUILD_TAG}
            echo "→ Building $svc with image: $image"
            cp -r libs services/$svc/
            docker build -t "$image" services/$svc
            docker push "$image"
            rm -rf services/$svc/libs
          done

      # 4) Build & push frontend
      - name: Build & push frontend
        if: steps.detect.outputs.build_frontend == 'true'
        run: |
          image=${{ secrets.DOCKER_USERNAME }}/${STACK_NAME}-frontend:${BUILD_TAG}
          echo "→ Building frontend with image: $image"
          docker build -t "$image" frontend
          docker push "$image"

      # 5) Configure kubectl for GKE
      - name: Set up GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Set up kubectl secrets
        run: |
          kubectl create secret generic mysql-secrets \
            --from-literal=MYSQL_PASSWORD="${{ secrets.STAGING_MYSQL_PASSWORD }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic rabbitmq-secrets \
            --from-literal=RABBITMQ_PASSWORD="${{ secrets.STAGING_RABBITMQ_PASSWORD }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic redis-secrets \
            --from-literal=REDIS_URL="${{ secrets.STAGING_REDIS_URL }}" \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic service-secrets \
            --from-literal=ROOT_USER_PASSWORD="${{ secrets.STAGING_ROOT_USER_PASSWORD }}" \
            --from-literal=SECRET_KEY="${{ secrets.STAGING_SECRET_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      # 6) Deploy changed services to EKS
      - name: Deploy services to Kubernetes
        if: steps.detect.outputs.services != ''
        run: |
          IFS=, read -ra SVCS <<< "${{ steps.detect.outputs.services }}"
          for svc in "${SVCS[@]}"; do
            export IMAGE=${{ secrets.DOCKER_USERNAME }}/${STACK_NAME}-${svc,,}:${BUILD_TAG}
            echo "→ Deploying $svc with image: $image"
            for manifest in k8s/deployments/services/$svc/*; do
              envsubst < "$manifest" | kubectl apply -f -
            done
          done

      # 7) Deploy frontend to EKS
      - name: Deploy frontend to Kubernetes
        if: steps.detect.outputs.build_frontend == 'true'
        run: |
          export IMAGE=${{ secrets.DOCKER_USERNAME }}/${STACK_NAME}-frontend:${BUILD_TAG}
          echo "→ Deploying frontend with image: $IMAGE"
          for manifest in k8s/deployments/frontend/*; do
            envsubst < "$manifest" | kubectl apply -f -
          done
